<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routing Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .controls select, .controls button {
            margin: 5px 0;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }
        .controls button {
            background: green;
            color: white;
            font-weight: bold;
        }
        .controls button.secondary {
            background: #007bff;
        }
        .controls button:disabled {
            background: gray;
            cursor: not-allowed;
        }
        .distance {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="controls">
    <select id="bikeSelector">
        <option value="" disabled selected>Select a Bike</option>
        <option value="Bike 1">Bike 1</option>
        <option value="Bike 2">Bike 2</option>
        <option value="Bike 3">Bike 3</option>
    </select>
    <button id="findDestination">Find Destination</button>
    <button id="trackingBike">Start Tracking</button>
    <button id="showLocation" class="secondary">Show Location</button>
    <p class="distance" id="distanceLabel">Total Distance: N/A</p>
</div>

<script>
    // Initialize the map
    const map = L.map('map').setView([21.022736, 105.852194], 13);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // Bike icons
    const bikeIcons = {
        "Bike 1": L.icon({
            iconUrl: "https://i.postimg.cc/6qxZPGW0/bike-1-removebg-preview.png",
            iconSize: [40, 40]
        }),
        "Bike 2": L.icon({
            iconUrl: "https://i.postimg.cc/0jGS12rq/bike-2-removebg-preview.png",
            iconSize: [40, 40]
        }),
        "Bike 3": L.icon({
            iconUrl: "https://i.postimg.cc/QNc1TSmn/bike-3-removebg-preview.png",
            iconSize: [40, 40]
        })
    };

    const currentLocation = [21.022736, 105.852194];
    const currentMarker = L.marker(currentLocation, {
        icon: L.icon({
            iconUrl: "https://i.postimg.cc/ZnWC4bDD/location-removebg-preview.png",
            iconSize: [30, 30]
        })
    }).addTo(map);

    let routingControl = null;
    let trackingInterval = null;
    let selectedBike = null;
    let locationVisible = true;

    const bikeSelector = document.getElementById('bikeSelector');
    const findDestinationButton = document.getElementById('findDestination');
    const trackingBikeButton = document.getElementById('trackingBike');
    const showLocationButton = document.getElementById('showLocation');
    const distanceLabel = document.getElementById('distanceLabel');

    // Toggle location visibility
    showLocationButton.addEventListener('click', () => {
        locationVisible = !locationVisible;
        if (locationVisible) {
            map.addLayer(currentMarker);
            showLocationButton.textContent = "Hide Location";
            showLocationButton.style.background = "red";
        } else {
            map.removeLayer(currentMarker);
            showLocationButton.textContent = "Show Location";
            showLocationButton.style.background = "#007bff";
        }
    });

    // Generate random points within 3 km radius
    function generateRandomPoint(center, radius = 3000) {
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * radius;
        const dx = distance * Math.cos(angle);
        const dy = distance * Math.sin(angle);
        const latOffset = dy / 111320; // Convert meters to latitude
        const lonOffset = dx / (111320 * Math.cos(center[0] * Math.PI / 180)); // Adjust for longitude
        return [center[0] + latOffset, center[1] + lonOffset];
    }

    // Handle bike selection
    bikeSelector.addEventListener('change', () => {
        selectedBike = bikeSelector.value;
        if (selectedBike) {
            alert(`Selected: ${selectedBike}`);
        }
    });

    // Handle "Find Destination" functionality
    findDestinationButton.addEventListener('click', () => {
        if (!selectedBike) {
            alert('Please select a bike first!');
            return;
        }

        if (routingControl) {
            map.removeControl(routingControl);
        }

        const destination = generateRandomPoint(currentLocation);
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(currentLocation),
                L.latLng(destination)
            ],
            routeWhileDragging: false,
            createMarker: () => null
        }).addTo(map);

        routingControl.on('routesfound', (e) => {
            const distanceInMeters = e.routes[0].summary.totalDistance;
            const distanceInKm = (distanceInMeters / 1000).toFixed(2);
            distanceLabel.textContent = `Total Distance: ${distanceInKm} km`;
        });
    });

    // Handle "Tracking Bike" functionality
    trackingBikeButton.addEventListener('click', () => {
        if (!selectedBike) {
            alert('Please select a bike first!');
            return;
        }

        if (trackingInterval) {
            clearInterval(trackingInterval);
        }

        const bikeMarker = L.marker(currentLocation, {
            icon: bikeIcons[selectedBike]
        }).addTo(map);

        const randomPoints = Array.from({ length: 5 }, () => generateRandomPoint(currentLocation));
        let pointIndex = 0;

        trackingInterval = setInterval(() => {
            if (pointIndex >= randomPoints.length) {
                clearInterval(trackingInterval);
                return;
            }

            bikeMarker.setLatLng(randomPoints[pointIndex]);
            const auraCircle = L.circle(randomPoints[pointIndex], {
                radius: 100,
                color: 'blue',
                fillColor: 'blue',
                fillOpacity: 0.3
            }).addTo(map);

            setTimeout(() => {
                map.removeLayer(auraCircle);
            }, 900);

            pointIndex++;
        }, 1000);
    });
</script>

</body>
</html>
